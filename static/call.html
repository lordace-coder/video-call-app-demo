<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video + Audio Calls</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
      }

      .call-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 30px;
        width: 100%;
        max-width: 1200px;
        text-align: center;
      }

      .room-info {
        margin-bottom: 20px;
      }

      .room-id {
        color: #666;
        font-size: 12px;
        word-break: break-all;
        background: #f5f5f5;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 15px;
      }

      .connection-status {
        font-weight: bold;
        margin-bottom: 15px;
        padding: 8px;
        border-radius: 6px;
        font-size: 14px;
      }

      .status-connected {
        background: #d4edda;
        color: #155724;
      }

      .status-connecting {
        background: #fff3cd;
        color: #856404;
      }

      .status-disconnected {
        background: #f8d7da;
        color: #721c24;
      }

      .media-settings {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .media-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f8f9fa;
        padding: 10px 15px;
        border-radius: 25px;
        border: 2px solid #e0e0e0;
        cursor: pointer;
        transition: all 0.3s;
      }

      .media-toggle:hover {
        border-color: #007bff;
      }

      .media-toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .video-grid {
        display: grid;
        gap: 15px;
        margin-bottom: 20px;
        justify-content: center;
      }

      .video-grid.single {
        grid-template-columns: 1fr;
      }

      .video-grid.dual {
        grid-template-columns: 1fr 1fr;
      }

      .video-grid.multi {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }

      .video-container {
        position: relative;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 16/9;
        max-width: 400px;
        margin: 0 auto;
      }

      .video-element {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
      }

      .participants {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .participant-list {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 10px;
      }

      .participant {
        background: #007bff;
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 500;
      }

      .participant.you {
        background: #28a745;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .control-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.3s ease;
      }

      .mic-btn {
        background: #28a745;
        color: white;
      }

      .mic-btn.muted {
        background: #dc3545;
      }

      .camera-btn {
        background: #17a2b8;
        color: white;
      }

      .camera-btn.off {
        background: #6c757d;
      }

      .screen-btn {
        background: #ffc107;
        color: white;
      }

      .screen-btn.sharing {
        background: #fd7e14;
      }

      .screen-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .hang-up-btn {
        background: #dc3545;
        color: white;
      }

      .control-btn:hover:not(:disabled) {
        transform: scale(1.1);
      }

      .join-section {
        display: none;
      }

      .join-section.show {
        display: block;
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #007bff;
      }

      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.3s;
        width: 100%;
      }

      .btn:hover {
        background: #0056b3;
      }

      .btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 6px;
        margin: 10px 0;
        font-size: 12px;
      }

      .logs {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        max-height: 150px;
        overflow-y: auto;
        font-size: 11px;
        text-align: left;
        margin-top: 15px;
      }

      .log-entry {
        margin-bottom: 3px;
        padding: 3px;
        border-radius: 3px;
      }

      .log-info {
        background: #d1ecf1;
        color: #0c5460;
      }

      .log-error {
        background: #f8d7da;
        color: #721c24;
      }

      .log-success {
        background: #d4edda;
        color: #155724;
      }

      /* Mobile-specific styles */
      @media (max-width: 768px) {
        body {
          padding: 5px;
        }

        .call-container {
          padding: 15px;
          border-radius: 15px;
        }

        .video-grid.dual {
          grid-template-columns: 1fr;
        }

        .video-grid.multi {
          grid-template-columns: 1fr;
        }

        .controls {
          gap: 10px;
        }

        .control-btn {
          width: 45px;
          height: 45px;
          font-size: 18px;
        }

        .media-settings {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="call-container">
      <div class="join-section show" id="joinSection">
        <h1>Join Video Call</h1>
        <div class="input-group">
          <input
            type="text"
            id="userIdInput"
            placeholder="Enter your name"
            required
          />
        </div>
        <div class="input-group">
          <input
            type="text"
            id="roomIdInput"
            placeholder="Room ID (optional - will create new if empty)"
          />
        </div>
        <div class="media-settings">
          <label class="media-toggle">
            <input type="checkbox" id="enableVideo" checked />
            <span>üìπ Video</span>
          </label>
          <label class="media-toggle">
            <input type="checkbox" id="enableAudio" checked />
            <span>üé§ Audio</span>
          </label>
        </div>
        <div id="errorContainer"></div>
        <button class="btn" onclick="joinCall()" id="joinBtn">Join Call</button>
      </div>

      <div class="call-section" id="callSection" style="display: none">
        <div class="room-info">
          <h2>Video Call</h2>
          <div class="room-id" id="roomIdDisplay"></div>
          <div class="connection-status" id="connectionStatus">
            Connecting...
          </div>
        </div>

        <div class="video-grid single" id="videoGrid">
          <div class="video-container" id="localVideoContainer">
            <video
              class="video-element"
              id="localVideo"
              muted
              autoplay
              playsinline
              webkit-playsinline
            ></video>
            <div class="video-label">You</div>
          </div>
        </div>

        <div class="participants">
          <h3>Participants (<span id="participantCount">1</span>)</h3>
          <div class="participant-list" id="participantList"></div>
        </div>

        <div class="controls">
          <button class="control-btn mic-btn" id="micBtn" onclick="toggleMic()">
            üé§
          </button>
          <button
            class="control-btn camera-btn"
            id="cameraBtn"
            onclick="toggleCamera()"
          >
            üìπ
          </button>
          <button
            class="control-btn screen-btn"
            id="screenBtn"
            onclick="toggleScreenShare()"
            style="display: none"
          >
            üñ•Ô∏è
          </button>
          <button class="control-btn hang-up-btn" onclick="hangUp()">üìû</button>
        </div>

        <div class="logs" id="logs"></div>
      </div>
    </div>

    <script>
      // Device and capability detection
      const isMobile =
        /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        );
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      // Feature detection
      const hasGetUserMedia = !!(
        navigator.mediaDevices && navigator.mediaDevices.getUserMedia
      );
      const hasGetDisplayMedia = !!(
        navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia
      );

      // Global variables
      let ws = null;
      let localStream = null;
      let peerConnections = new Map();
      let userId = null;
      let roomId = null;
      let isMuted = false;
      let isCameraOff = false;

      // ICE servers configuration
      const iceServers = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
        ],
      };

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        initializeApp();
      });

      function initializeApp() {
        log(`Device: ${isMobile ? "Mobile" : "Desktop"}`, "info");

        // Check for required APIs
        if (!hasGetUserMedia) {
          showError(
            "Your browser does not support camera/microphone access. Please use a modern browser."
          );
          return;
        }

        // Hide screen share button on mobile or if not supported
        if (isMobile || !hasGetDisplayMedia) {
          document.getElementById("screenBtn").style.display = "none";
          log("Screen sharing not available on this device", "info");
        }

        // iOS specific optimizations
        if (isIOS) {
          log("iOS device detected - applying optimizations", "info");
          // iOS requires user gesture for audio context
          document.addEventListener("touchstart", enableIOSAudio, {
            once: true,
          });
        }

        log("App initialized successfully", "success");
      }

      function enableIOSAudio() {
        // Create and play silent audio to enable audio context on iOS
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        gainNode.gain.value = 0;
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.1);

        log("iOS audio context enabled", "info");
      }

      function showError(message) {
        const errorContainer = document.getElementById("errorContainer");
        errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
      }

      function clearError() {
        document.getElementById("errorContainer").innerHTML = "";
      }

      function log(message, type = "info") {
        const logsDiv = document.getElementById("logs");
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry log-${type}`;
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logsDiv.appendChild(logEntry);
        logsDiv.scrollTop = logsDiv.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
      }

      function updateConnectionStatus(status) {
        const statusDiv = document.getElementById("connectionStatus");
        statusDiv.className = `connection-status status-${status}`;

        switch (status) {
          case "connected":
            statusDiv.textContent = "Connected";
            break;
          case "connecting":
            statusDiv.textContent = "Connecting...";
            break;
          case "disconnected":
            statusDiv.textContent = "Disconnected";
            break;
        }
      }

      function updateParticipants(participants) {
        const participantList = document.getElementById("participantList");
        const participantCount = document.getElementById("participantCount");

        participantList.innerHTML = "";
        participantCount.textContent = participants.length;

        participants.forEach((participant) => {
          const participantDiv = document.createElement("div");
          participantDiv.className = `participant ${
            participant === userId ? "you" : ""
          }`;
          participantDiv.textContent =
            participant === userId ? `${participant} (You)` : participant;
          participantList.appendChild(participantDiv);
        });

        updateVideoGrid(participants.length);
      }

      function updateVideoGrid(participantCount) {
        const videoGrid = document.getElementById("videoGrid");
        if (isMobile && participantCount > 2) {
          videoGrid.className = "video-grid single"; // Stack videos on mobile
        } else {
          videoGrid.className =
            "video-grid " +
            (participantCount === 1
              ? "single"
              : participantCount === 2
              ? "dual"
              : "multi");
        }
      }

      function getMobileOptimizedConstraints(enableVideo, enableAudio) {
        const constraints = {};

        if (enableAudio) {
          constraints.audio = {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
          };

          if (isMobile) {
            constraints.audio.sampleRate = 44100;
          } else {
            constraints.audio.sampleRate = 48000;
          }
        }

        if (enableVideo) {
          if (isMobile) {
            constraints.video = {
              width: { ideal: 640, max: 1280 },
              height: { ideal: 480, max: 720 },
              frameRate: { ideal: 15, max: 24 },
              facingMode: "user",
            };
          } else {
            constraints.video = {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              frameRate: { ideal: 30 },
            };
          }
        }

        return constraints;
      }

      async function joinCall() {
        const userIdInput = document.getElementById("userIdInput");
        const roomIdInput = document.getElementById("roomIdInput");
        const enableVideo = document.getElementById("enableVideo").checked;
        const enableAudio = document.getElementById("enableAudio").checked;
        const joinBtn = document.getElementById("joinBtn");

        clearError();

        userId = userIdInput.value.trim();
        if (!userId) {
          showError("Please enter your name");
          return;
        }

        if (!enableVideo && !enableAudio) {
          showError("Please enable at least audio or video");
          return;
        }

        joinBtn.disabled = true;

        try {
          // Get room ID or create new one
          if (roomIdInput.value.trim()) {
            roomId = roomIdInput.value.trim();
          } else {
            try {
              const response = await fetch("/rooms", { method: "POST" });
              const data = await response.json();
              roomId = data.room_id;
            } catch (fetchError) {
              throw new Error(
                "Cannot connect to server. Make sure it is running."
              );
            }
          }

          document.getElementById(
            "roomIdDisplay"
          ).textContent = `Room ID: ${roomId}`;

          // Get user media with fallbacks
          const mediaConstraints = getMobileOptimizedConstraints(
            enableVideo,
            enableAudio
          );
          log(`Requesting media: ${JSON.stringify(mediaConstraints)}`, "info");

          try {
            localStream = await navigator.mediaDevices.getUserMedia(
              mediaConstraints
            );

            if (enableVideo) {
              const localVideo = document.getElementById("localVideo");
              localVideo.srcObject = localStream;

              // Ensure video plays on mobile
              localVideo.play().catch((e) => {
                log(`Video play failed: ${e.message}`, "error");
              });

              log("Got video and audio stream", "success");
            } else {
              log("Got audio stream", "success");
              document.getElementById("localVideoContainer").style.display =
                "none";
            }
          } catch (mediaError) {
            log(`Media error: ${mediaError.message}`, "error");

            // Try audio-only fallback
            if (enableVideo && enableAudio) {
              log("Trying audio-only fallback...", "info");
              try {
                const audioOnlyConstraints = getMobileOptimizedConstraints(
                  false,
                  true
                );
                localStream = await navigator.mediaDevices.getUserMedia(
                  audioOnlyConstraints
                );
                log("Audio-only fallback successful", "success");
                document.getElementById("localVideoContainer").style.display =
                  "none";
              } catch (audioError) {
                throw new Error(`Media access failed: ${audioError.message}`);
              }
            } else {
              throw mediaError;
            }
          }

          // Connect to WebSocket
          const wsProtocol =
            window.location.protocol === "https:" ? "ws:" : "ws:";
          const wsHost = window.location.host;
          const wsUrl = `${wsProtocol}//${wsHost}/ws/${encodeURIComponent(
            userId
          )}`;

          log(`Connecting to: ${wsUrl}`, "info");
          ws = new WebSocket(wsUrl);

          const connectionTimeout = setTimeout(() => {
            if (ws.readyState !== WebSocket.OPEN) {
              log("Connection timeout", "error");
              ws.close();
              joinBtn.disabled = false;
              updateConnectionStatus("disconnected");
              showError(
                "Connection timeout. Please check your network connection."
              );
            }
          }, 15000);

          ws.onopen = () => {
            clearTimeout(connectionTimeout);
            log("WebSocket connected successfully", "success");
            updateConnectionStatus("connected");

            ws.send(
              JSON.stringify({
                type: "join-room",
                room_id: roomId,
              })
            );

            document.getElementById("joinSection").style.display = "none";
            document.getElementById("callSection").style.display = "block";
          };

          ws.onmessage = handleSignalingMessage;

          ws.onerror = (error) => {
            clearTimeout(connectionTimeout);
            log("WebSocket error", "error");
            updateConnectionStatus("disconnected");
            joinBtn.disabled = false;
            showError(
              "Connection failed. Please check if the server is running."
            );
          };

          ws.onclose = (event) => {
            clearTimeout(connectionTimeout);
            log(`Connection closed: ${event.code}`, "info");
            updateConnectionStatus("disconnected");
            joinBtn.disabled = false;
          };
        } catch (error) {
          log("Error joining call: " + error.message, "error");
          joinBtn.disabled = false;

          if (error.name === "NotAllowedError") {
            showError(
              "Camera/microphone access denied. Please allow access and try again."
            );
          } else if (error.name === "NotFoundError") {
            showError("Camera or microphone not found on this device.");
          } else if (error.name === "NotSupportedError") {
            showError("Your browser does not support the required features.");
          } else {
            showError(`Error: ${error.message}`);
          }
        }
      }

      async function handleSignalingMessage(event) {
        try {
          const message = JSON.parse(event.data);

          switch (message.type) {
            case "room-joined":
              log(`Joined room: ${message.room_id}`, "success");
              updateParticipants(message.participants);
              break;

            case "user-joined":
              log(`${message.user_id} joined the call`, "info");
              updateParticipants(message.participants);
              if (message.user_id !== userId) {
                await createPeerConnection(message.user_id, true);
              }
              break;

            case "user-left":
              log(`${message.user_id} left the call`, "info");
              updateParticipants(message.participants);
              removeRemoteVideoElement(message.user_id);
              if (peerConnections.has(message.user_id)) {
                peerConnections.get(message.user_id).close();
                peerConnections.delete(message.user_id);
              }
              break;

            case "offer":
              await handleOffer(message.from_user, message.data);
              break;

            case "answer":
              await handleAnswer(message.from_user, message.data);
              break;

            case "ice-candidate":
              await handleIceCandidate(message.from_user, message.data);
              break;

            case "room-closed":
              log("Room was closed", "info");
              hangUp();
              break;
          }
        } catch (error) {
          log(`Error processing message: ${error.message}`, "error");
        }
      }

      function createRemoteVideoElement(remoteUserId) {
        const videoGrid = document.getElementById("videoGrid");

        const videoContainer = document.createElement("div");
        videoContainer.className = "video-container";
        videoContainer.id = `video-container-${remoteUserId}`;

        const video = document.createElement("video");
        video.className = "video-element";
        video.id = `video-${remoteUserId}`;
        video.autoplay = true;
        video.playsinline = true;

        if (isIOS) {
          video.setAttribute("webkit-playsinline", "");
        }

        const label = document.createElement("div");
        label.className = "video-label";
        label.textContent = remoteUserId;

        videoContainer.appendChild(video);
        videoContainer.appendChild(label);
        videoGrid.appendChild(videoContainer);

        return video;
      }

      function removeRemoteVideoElement(remoteUserId) {
        const videoContainer = document.getElementById(
          `video-container-${remoteUserId}`
        );
        if (videoContainer) {
          videoContainer.remove();
        }
      }

      async function createPeerConnection(remoteUserId, createOffer = false) {
        try {
          const peerConnection = new RTCPeerConnection(iceServers);
          peerConnections.set(remoteUserId, peerConnection);

          if (localStream) {
            localStream.getTracks().forEach((track) => {
              peerConnection.addTrack(track, localStream);
            });
          }

          peerConnection.ontrack = (event) => {
            const remoteVideo = createRemoteVideoElement(remoteUserId);
            remoteVideo.srcObject = event.streams[0];

            // Ensure video plays
            remoteVideo.play().catch((e) => {
              log(`Remote video play failed: ${e.message}`, "error");
            });

            log(`Receiving media from ${remoteUserId}`, "success");
          };

          peerConnection.onicecandidate = (event) => {
            if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
              ws.send(
                JSON.stringify({
                  type: "ice-candidate",
                  data: event.candidate,
                  to_user: remoteUserId,
                })
              );
            }
          };

          if (createOffer) {
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(
                JSON.stringify({
                  type: "offer",
                  data: offer,
                  to_user: remoteUserId,
                })
              );
            }
          }

          return peerConnection;
        } catch (error) {
          log(
            `Error creating peer connection with ${remoteUserId}: ${error.message}`,
            "error"
          );
        }
      }

      async function handleOffer(fromUserId, offer) {
        try {
          const peerConnection = await createPeerConnection(fromUserId);
          await peerConnection.setRemoteDescription(offer);

          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);

          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(
              JSON.stringify({
                type: "answer",
                data: answer,
                to_user: fromUserId,
              })
            );
          }
        } catch (error) {
          log(
            `Error handling offer from ${fromUserId}: ${error.message}`,
            "error"
          );
        }
      }

      async function handleAnswer(fromUserId, answer) {
        try {
          const peerConnection = peerConnections.get(fromUserId);
          if (peerConnection) {
            await peerConnection.setRemoteDescription(answer);
          }
        } catch (error) {
          log(
            `Error handling answer from ${fromUserId}: ${error.message}`,
            "error"
          );
        }
      }

      async function handleIceCandidate(fromUserId, candidate) {
        try {
          const peerConnection = peerConnections.get(fromUserId);
          if (peerConnection) {
            await peerConnection.addIceCandidate(candidate);
          }
        } catch (error) {
          log(
            `Error handling ICE candidate from ${fromUserId}: ${error.message}`,
            "error"
          );
        }
      }

      function toggleMic() {
        if (localStream) {
          const audioTrack = localStream.getAudioTracks()[0];
          if (audioTrack) {
            audioTrack.enabled = !audioTrack.enabled;
            isMuted = !audioTrack.enabled;

            const micBtn = document.getElementById("micBtn");
            micBtn.className = `control-btn mic-btn ${isMuted ? "muted" : ""}`;
            micBtn.textContent = isMuted ? "üîá" : "üé§";

            log(isMuted ? "Microphone muted" : "Microphone unmuted", "info");
          }
        }
      }

      function toggleCamera() {
        if (localStream) {
          const videoTrack = localStream.getVideoTracks()[0];
          if (videoTrack) {
            videoTrack.enabled = !videoTrack.enabled;
            isCameraOff = !videoTrack.enabled;

            const cameraBtn = document.getElementById("cameraBtn");
            cameraBtn.className = `control-btn camera-btn ${
              isCameraOff ? "off" : ""
            }`;
            cameraBtn.textContent = isCameraOff ? "üì∑" : "üìπ";

            log(isCameraOff ? "Camera off" : "Camera on", "info");
          }
        }
      }

      async function toggleScreenShare() {
        // Check if screen sharing is supported
        if (!hasGetDisplayMedia) {
          log("Screen sharing not supported on this device", "error");
          return;
        }

        const screenBtn = document.getElementById("screenBtn");

        try {
          if (!screenBtn.classList.contains("sharing")) {
            // Start screen sharing
            const screenStream = await navigator.mediaDevices.getDisplayMedia({
              video: true,
              audio: true,
            });

            const videoTrack = screenStream.getVideoTracks()[0];

            // Replace video track in all peer connections
            for (const [userId, pc] of peerConnections) {
              const sender = pc
                .getSenders()
                .find((s) => s.track && s.track.kind === "video");
              if (sender) {
                await sender.replaceTrack(videoTrack);
              }
            }

            // Update local video
            const localVideo = document.getElementById("localVideo");
            localVideo.srcObject = screenStream;

            screenBtn.classList.add("sharing");
            screenBtn.textContent = "üîÑ";

            // Handle screen share end
            videoTrack.onended = () => {
              stopScreenShare();
            };

            log("Screen sharing started", "success");
          } else {
            stopScreenShare();
          }
        } catch (error) {
          log("Screen sharing failed: " + error.message, "error");
        }
      }

      async function stopScreenShare() {
        const screenBtn = document.getElementById("screenBtn");

        // Restore camera video if available
        if (localStream) {
          const videoTrack = localStream.getVideoTracks()[0];
          for (const [userId, pc] of peerConnections) {
            const sender = pc
              .getSenders()
              .find((s) => s.track && s.track.kind === "video");
            if (sender && videoTrack) {
              await sender.replaceTrack(videoTrack);
            }
          }

          // Update local video
          const localVideo = document.getElementById("localVideo");
          localVideo.srcObject = localStream;
        }

        screenBtn.classList.remove("sharing");
        screenBtn.textContent = "üñ•Ô∏è";

        log("Screen sharing stopped", "info");
      }

      function hangUp() {
        // Stop screen sharing if active
        if (
          document.getElementById("screenBtn").classList.contains("sharing")
        ) {
          stopScreenShare();
        }

        // Close all peer connections
        peerConnections.forEach((pc) => pc.close());
        peerConnections.clear();

        // Stop local streams
        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
          localStream = null;
        }

        // Close WebSocket
        if (ws) {
          ws.close();
          ws = null;
        }

        // Reset UI
        document.getElementById("callSection").style.display = "none";
        document.getElementById("joinSection").style.display = "block";
        document.getElementById("joinSection").className = "join-section show";
        document.getElementById("joinBtn").disabled = false;
        document.getElementById("userIdInput").value = "";
        document.getElementById("roomIdInput").value = "";

        // Clear video grid except local video container
        const videoGrid = document.getElementById("videoGrid");
        const localContainer = document.getElementById("localVideoContainer");
        videoGrid.innerHTML = "";
        videoGrid.appendChild(localContainer);
        localContainer.style.display = "block";

        // Reset button states
        const micBtn = document.getElementById("micBtn");
        const cameraBtn = document.getElementById("cameraBtn");
        const screenBtn = document.getElementById("screenBtn");

        micBtn.className = "control-btn mic-btn";
        micBtn.textContent = "üé§";
        cameraBtn.className = "control-btn camera-btn";
        cameraBtn.textContent = "üìπ";
        screenBtn.className = "control-btn screen-btn";
        screenBtn.textContent = "üñ•Ô∏è";

        isMuted = false;
        isCameraOff = false;

        clearError();
        log("Call ended", "info");
      }

      // Auto-fill room ID from URL if present
      window.onload = () => {
        const urlParts = window.location.pathname.split("/");
        if (urlParts[1] === "call" && urlParts[2]) {
          document.getElementById("roomIdInput").value = urlParts[2];
        }
      };
    </script>
  </body>
</html>
